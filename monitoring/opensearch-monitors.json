{
  "monitors": [
    {
      "name": "Docker Container Health Monitor",
      "description": "Monitor Docker container health status and uptime",
      "type": "monitor",
      "monitor_type": "query_level_monitor",
      "enabled": true,
      "schedule": {
        "period": {
          "interval": 1,
          "unit": "MINUTES"
        }
      },
      "inputs": [{
        "search": {
          "indices": ["metricbeat-*"],
          "query": {
            "bool": {
              "must": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-5m"
                    }
                  }
                },
                {
                  "term": {
                    "metricset.name": "container"
                  }
                },
                {
                  "exists": {
                    "field": "docker.container.status"
                  }
                }
              ],
              "must_not": [
                {
                  "terms": {
                    "docker.container.status": ["running", "created"]
                  }
                }
              ]
            }
          },
          "size": 100
        }
      }],
      "triggers": [{
        "name": "Container Down Alert",
        "severity": "1",
        "condition": {
          "script": {
            "source": "ctx.results[0].hits.total.value > 0",
            "lang": "painless"
          }
        },
        "actions": [{
          "name": "notify-container-down",
          "destination_id": "<your-destination-id>",
          "message_template": {
            "source": "Containers not running:\n{{#ctx.results.0.hits.hits}}- {{_source.container.name}} (Status: {{_source.docker.container.status}})\n{{/ctx.results.0.hits.hits}}",
            "lang": "mustache"
          },
          "subject_template": {
            "source": "Alert: Docker Containers Down",
            "lang": "mustache"
          }
        }]
      }]
    },
    {
      "name": "High CPU Usage Monitor",
      "description": "Alert when system or container CPU usage is high",
      "type": "monitor",
      "monitor_type": "query_level_monitor",
      "enabled": true,
      "schedule": {
        "period": {
          "interval": 5,
          "unit": "MINUTES"
        }
      },
      "inputs": [{
        "search": {
          "indices": ["metricbeat-*"],
          "query": {
            "bool": {
              "should": [
                {
                  "bool": {
                    "must": [
                      {
                        "range": {
                          "@timestamp": {
                            "gte": "now-5m"
                          }
                        }
                      },
                      {
                        "range": {
                          "system.cpu.total.pct": {
                            "gte": 0.8
                          }
                        }
                      }
                    ]
                  }
                },
                {
                  "bool": {
                    "must": [
                      {
                        "range": {
                          "@timestamp": {
                            "gte": "now-5m"
                          }
                        }
                      },
                      {
                        "range": {
                          "docker.cpu.total.pct": {
                            "gte": 0.8
                          }
                        }
                      }
                    ]
                  }
                }
              ]
            }
          },
          "aggs": {
            "avg_cpu": {
              "avg": {
                "field": "system.cpu.total.pct"
              }
            },
            "max_cpu": {
              "max": {
                "field": "system.cpu.total.pct"
              }
            }
          }
        }
      }],
      "triggers": [{
        "name": "High CPU Alert",
        "severity": "2",
        "condition": {
          "script": {
            "source": "ctx.results[0].hits.total.value > 0 || (ctx.results[0].aggregations.avg_cpu.value != null && ctx.results[0].aggregations.avg_cpu.value > 0.8)",
            "lang": "painless"
          }
        },
        "actions": [{
          "name": "notify-high-cpu",
          "destination_id": "<your-destination-id>",
          "message_template": {
            "source": "High CPU usage detected!\nAverage CPU: {{ctx.results.0.aggregations.avg_cpu.value}}%\nMax CPU: {{ctx.results.0.aggregations.max_cpu.value}}%",
            "lang": "mustache"
          },
          "subject_template": {
            "source": "Alert: High CPU Usage",
            "lang": "mustache"
          }
        }]
      }]
    },
    {
      "name": "High Memory Usage Monitor",
      "description": "Alert when system or container memory usage is high",
      "type": "monitor",
      "monitor_type": "query_level_monitor",
      "enabled": true,
      "schedule": {
        "period": {
          "interval": 5,
          "unit": "MINUTES"
        }
      },
      "inputs": [{
        "search": {
          "indices": ["metricbeat-*"],
          "query": {
            "bool": {
              "must": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-5m"
                    }
                  }
                },
                {
                  "range": {
                    "system.memory.used.pct": {
                      "gte": 0.85
                    }
                  }
                }
              ]
            }
          },
          "aggs": {
            "avg_memory": {
              "avg": {
                "field": "system.memory.used.pct"
              }
            }
          }
        }
      }],
      "triggers": [{
        "name": "High Memory Alert",
        "severity": "2",
        "condition": {
          "script": {
            "source": "ctx.results[0].aggregations.avg_memory.value != null && ctx.results[0].aggregations.avg_memory.value > 0.85",
            "lang": "painless"
          }
        },
        "actions": [{
          "name": "notify-high-memory",
          "destination_id": "<your-destination-id>",
          "message_template": {
            "source": "High memory usage detected!\nAverage Memory Usage: {{ctx.results.0.aggregations.avg_memory.value}}%",
            "lang": "mustache"
          },
          "subject_template": {
            "source": "Alert: High Memory Usage",
            "lang": "mustache"
          }
        }]
      }]
    },
    {
      "name": "Disk Space Monitor",
      "description": "Alert when disk space is running low",
      "type": "monitor",
      "monitor_type": "query_level_monitor",
      "enabled": true,
      "schedule": {
        "period": {
          "interval": 15,
          "unit": "MINUTES"
        }
      },
      "inputs": [{
        "search": {
          "indices": ["metricbeat-*"],
          "query": {
            "bool": {
              "must": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-15m"
                    }
                  }
                },
                {
                  "range": {
                    "system.filesystem.used.pct": {
                      "gte": 0.9
                    }
                  }
                }
              ]
            }
          }
        }
      }],
      "triggers": [{
        "name": "Low Disk Space Alert",
        "severity": "1",
        "condition": {
          "script": {
            "source": "ctx.results[0].hits.total.value > 0",
            "lang": "painless"
          }
        },
        "actions": [{
          "name": "notify-low-disk",
          "destination_id": "<your-destination-id>",
          "message_template": {
            "source": "Low disk space detected!\n{{#ctx.results.0.hits.hits}}Filesystem: {{_source.system.filesystem.mount_point}} - {{_source.system.filesystem.used.pct}}% used\n{{/ctx.results.0.hits.hits}}",
            "lang": "mustache"
          },
          "subject_template": {
            "source": "Alert: Low Disk Space",
            "lang": "mustache"
          }
        }]
      }]
    },
    {
      "name": "Container Restart Monitor",
      "description": "Alert when containers are restarting frequently",
      "type": "monitor",
      "monitor_type": "query_level_monitor",
      "enabled": true,
      "schedule": {
        "period": {
          "interval": 5,
          "unit": "MINUTES"
        }
      },
      "inputs": [{
        "search": {
          "indices": ["metricbeat-*"],
          "query": {
            "bool": {
              "must": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-10m"
                    }
                  }
                },
                {
                  "term": {
                    "event.dataset": "docker.container"
                  }
                },
                {
                  "range": {
                    "docker.container.status.restart_count": {
                      "gt": 3
                    }
                  }
                }
              ]
            }
          }
        }
      }],
      "triggers": [{
        "name": "Container Restart Alert",
        "severity": "2",
        "condition": {
          "script": {
            "source": "ctx.results[0].hits.total.value > 0",
            "lang": "painless"
          }
        },
        "actions": [{
          "name": "notify-container-restarts",
          "destination_id": "<your-destination-id>",
          "message_template": {
            "source": "Containers restarting frequently:\n{{#ctx.results.0.hits.hits}}- {{_source.container.name}} (Restarts: {{_source.docker.container.status.restart_count}})\n{{/ctx.results.0.hits.hits}}",
            "lang": "mustache"
          },
          "subject_template": {
            "source": "Alert: Container Restart Loop",
            "lang": "mustache"
          }
        }]
      }]
    }
  ]
} 